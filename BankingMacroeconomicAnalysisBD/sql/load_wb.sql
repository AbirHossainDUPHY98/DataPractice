CREATE TEMP TABLE temp_wb (
    year INT,
    value NUMERIC,
    indicator TEXT
);

-- Load each CSV
\copy temp_wb FROM '/home/abir/PaPa/MyGym/DataPractice/BankingMacroeconomicAnalysisBD/data_clean/world_bank1_clean.csv' CSV HEADER;
\copy temp_wb FROM '/home/abir/PaPa/MyGym/DataPractice/BankingMacroeconomicAnalysisBD/data_clean/world_bank2_clean.csv' CSV HEADER;

-- Insert into dim_time
INSERT INTO dim_time(year)
SELECT DISTINCT year
FROM temp_wb
ON CONFLICT DO NOTHING;

-- Insert into dim_source
INSERT INTO dim_source(source_name)
VALUES ('world_bank')
ON CONFLICT DO NOTHING;

-- Insert into dim_indicator
INSERT INTO dim_indicator(indicator_code, indicator_name, domain)
SELECT DISTINCT indicator, indicator,
       CASE WHEN indicator LIKE '%Loan%' OR indicator LIKE '%Deposit%' THEN 'banking'
            ELSE 'macro' END
FROM temp_wb
ON CONFLICT DO NOTHING;

-- Insert into fact table (macro or banking depending on domain)
INSERT INTO fact_macro(time_id, indicator_id, value, source_id)
SELECT t.time_id, i.indicator_id, w.value, s.source_id
FROM temp_wb w
JOIN dim_time t ON w.year = t.year
JOIN dim_indicator i ON w.indicator = i.indicator_code
JOIN dim_source s ON s.source_name = 'world_bank'
WHERE i.domain = 'macro';

INSERT INTO fact_banking(time_id, indicator_id, value, source_id)
SELECT t.time_id, i.indicator_id, w.value, s.source_id
FROM temp_wb w
JOIN dim_time t ON w.year = t.year
JOIN dim_indicator i ON w.indicator = i.indicator_code
JOIN dim_source s ON s.source_id = s.source_id
WHERE i.domain = 'banking';

DROP TABLE temp_wb;

